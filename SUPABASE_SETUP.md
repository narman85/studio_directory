# Supabase Database Setup Instructions

1. Log in to your Supabase dashboard
2. Go to the SQL Editor
3. Create a new query and paste the following SQL:

```sql
-- Drop existing tables first
DROP TABLE IF EXISTS studio_stats CASCADE;
DROP TABLE IF EXISTS studio_images CASCADE;
DROP TABLE IF EXISTS studio_ratings CASCADE;
DROP TABLE IF EXISTS studios CASCADE;

-- Create studios table
CREATE TABLE studios (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    phone_number VARCHAR(20) NOT NULL,
    address TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create studio_images table
CREATE TABLE studio_images (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    studio_id BIGINT REFERENCES studios(id) ON DELETE CASCADE,
    image_path TEXT NOT NULL,
    is_primary BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create studio_stats table
CREATE TABLE studio_stats (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    studio_id BIGINT REFERENCES studios(id) ON DELETE CASCADE,
    views INTEGER DEFAULT 0,
    phone_reveals INTEGER DEFAULT 0,
    last_viewed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create studio_ratings table
CREATE TABLE studio_ratings (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    studio_id BIGINT REFERENCES studios(id) ON DELETE CASCADE,
    rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
    ip_address VARCHAR(45) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (studio_id, ip_address)
);

-- Create updated_at trigger function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create triggers
CREATE TRIGGER update_studios_updated_at
    BEFORE UPDATE ON studios
    FOR EACH ROW
    EXECUTE PROCEDURE update_updated_at_column();

CREATE TRIGGER update_studio_stats_updated_at
    BEFORE UPDATE ON studio_stats
    FOR EACH ROW
    EXECUTE PROCEDURE update_updated_at_column();

CREATE TRIGGER update_studio_images_updated_at
    BEFORE UPDATE ON studio_images
    FOR EACH ROW
    EXECUTE PROCEDURE update_updated_at_column();

CREATE TRIGGER update_studio_ratings_updated_at
    BEFORE UPDATE ON studio_ratings
    FOR EACH ROW
    EXECUTE PROCEDURE update_updated_at_column();

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_studios_name ON studios(name);
CREATE INDEX IF NOT EXISTS idx_studio_images_studio_id ON studio_images(studio_id);
CREATE INDEX IF NOT EXISTS idx_studio_stats_studio_id ON studio_stats(studio_id);
CREATE INDEX IF NOT EXISTS idx_studio_ratings_studio_id ON studio_ratings(studio_id);
CREATE INDEX IF NOT EXISTS idx_studio_ratings_ip ON studio_ratings(studio_id, ip_address);

-- Enable RLS but allow all operations for now
ALTER TABLE studios ENABLE ROW LEVEL SECURITY;
ALTER TABLE studio_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE studio_stats ENABLE ROW LEVEL SECURITY;
ALTER TABLE studio_ratings ENABLE ROW LEVEL SECURITY;

-- Create policies for public access
CREATE POLICY "Enable read access for all users" ON studios FOR SELECT USING (true);
CREATE POLICY "Enable read access for all users" ON studio_images FOR SELECT USING (true);
CREATE POLICY "Enable read access for all users" ON studio_stats FOR SELECT USING (true);
CREATE POLICY "Enable read access for all users" ON studio_ratings FOR SELECT USING (true);

-- For development, also allow insert/update/delete
CREATE POLICY "Enable insert for all users" ON studios FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable update for all users" ON studios FOR UPDATE USING (true);
CREATE POLICY "Enable delete for all users" ON studios FOR DELETE USING (true);

CREATE POLICY "Enable insert for all users" ON studio_images FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable update for all users" ON studio_images FOR UPDATE USING (true);
CREATE POLICY "Enable delete for all users" ON studio_images FOR DELETE USING (true);

CREATE POLICY "Enable insert for all users" ON studio_stats FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable update for all users" ON studio_stats FOR UPDATE USING (true);
CREATE POLICY "Enable delete for all users" ON studio_stats FOR DELETE USING (true);

CREATE POLICY "Enable insert for all users" ON studio_ratings FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable update for all users" ON studio_ratings FOR UPDATE USING (true);
CREATE POLICY "Enable delete for all users" ON studio_ratings FOR DELETE USING (true);
```

4. Run the SQL query to create the tables and set up the database structure
5. After the tables are created, run the `setup_db.py` script to insert test data

Note: In a production environment, you would want to restrict the RLS policies to only allow appropriate access based on user roles.
